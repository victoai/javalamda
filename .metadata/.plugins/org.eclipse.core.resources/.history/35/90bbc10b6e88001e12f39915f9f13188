package annotation;

@ClassDesc("ğŸ¥ ë³‘ì› ì˜ˆì•½")
public class Appointment {

    @Blind
    private String name;

    @WeekDaysAvail({WeekDay.MON, WeekDay.WED, WeekDay.FRI})
    private WeekDay day;

    @NumLimit(type = LimitType.MIN, to = 9)
    @NumLimit(type = LimitType.MAX, to = 17)
    private int startHour;

    @MaxLength(20)
    String symptom;

    public Appointment(
            String name, WeekDay day, int startHour, String symptom
    ) {
        this.name = name;
        this.day = day;
        this.startHour = startHour;
        this.symptom = symptom;
    }

    @TestAndPrint(before = "ğŸ•°ï¸ ì˜ˆì•½ ë‚´ì—­ì„ ì¶œë ¥í•©ë‹ˆë‹¤.")
    public void print () {
        System.out.printf(
                "%së‹˜ %sìš”ì¼ %dì‹œ%n",
                name, day.getName(), startHour
        );
    }
    public static Object verifyObj (Object obj) throws Exception {
        Class<?> objClass = obj.getClass();
        ClassDesc cd = objClass.getAnnotation(ClassDesc.class);
        System.out.println(cd.value() + " ê²€ì¦ ì‹œì‘");

        for (var f : objClass.getDeclaredFields()) {
            f.setAccessible(true);

            Object val = f.get(obj);

            //  ğŸ§ª í•„ë“œì˜ ì–´ë…¸í…Œì´ì…˜ ê²€ì¦ ë° ì²˜ë¦¬
            for (var a : f.getAnnotations()) {

                //  ì²« ê¸€ì ì™¸ *ìœ¼ë¡œ
                if (a instanceof Blind) {
                    var s = (String) val;
                    f.set(obj, s.substring(0, 1) + "*".repeat(s.length() - 1));
                }

                //  ìµœëŒ€ ê¸¸ì´ ê²€ì¦
                if (a instanceof MaxLength) {
                    int maxLen = ((MaxLength) a).value();
                    if (((String) val).length() > maxLen) {
                        throw new Exception(
                                "%s ìµœëŒ€ ê¸¸ì´(%d) ì´ˆê³¼".formatted(f.getName(), maxLen)
                        );
                    }
                }

                //  ìµœì†Œê°’/ìµœëŒ€ê°’ ê²€ì¦
                //  ğŸ’¡ Repeatable ì—¬ëŸ¿ì„ ì¼ì„ ê²½ìš° ë¬¶ìŒìœ¼ë¡œ ë“¤ì–´ê°
                if (a instanceof NumLimits) {
                    //  ğŸ’¡ value ë©”ì†Œë“œê°€ NumLimit[] ë°˜í™˜
                    for (var nl : ((NumLimits) a).value()) {
                        verifyNumLimit(f.getName(), nl, (int) val);
                    }
                }
                //  ğŸ’¡ Repeatable ì´ì§€ë§Œ í•˜ë‚˜ë§Œ ë“¤ì–´ê°„ ê²½ìš°
                if (a instanceof NumLimit) {
                    verifyNumLimit(f.getName(), (NumLimit) a, (int) val);
                }

                //  ê°€ìš© ìš”ì¼ ê²€ì¦
                if (a instanceof WeekDaysAvail) {
                    var wda = (WeekDaysAvail) a;
                    var wd = (WeekDay) f.get(obj);
                    WeekDay[] availables = wda.value();
                    var available = false;
                    for (var inAvail : availables) {
                        if (wd == inAvail) available = true;
                    }
                    if (!available) throw new Exception(
                            "í•´ë‹¹ ìš”ì¼(%s) ë¶ˆê°€".formatted(wd.getName())
                    );
                }
            }
        }

        //  í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ë©”ì†Œë“œ ì‹¤í–‰
        for (var m : objClass.getDeclaredMethods()) {
            for (var a : m.getAnnotations()) {
                if (a instanceof TestAndPrint) {
                    var tp = (TestAndPrint) a;
                    var printBefore = tp.before();
                    var printAfter = tp.after();

                    if (!printBefore.isBlank())
                        System.out.println(printBefore);
                    m.invoke(obj);
                    if (!printAfter.isBlank())
                        System.out.println(printAfter);
                }
            }

        }

        return obj;
    }

    public static void verifyNumLimit (
            String fieldName, NumLimit nl, int val
    ) throws Exception {
        if (nl.type() == LimitType.MIN && val < nl.to())
            throw new Exception(
                "%s ë²”ìœ„(ìµœì†Œ %d) ì˜¤ë¥˜".formatted(fieldName, nl.to())
            );
        if (nl.type() == LimitType.MAX && val > nl.to())
            throw new Exception(
                "%s ë²”ìœ„(ìµœëŒ€ %d) ì˜¤ë¥˜".formatted(fieldName, nl.to())
            );
    }
}